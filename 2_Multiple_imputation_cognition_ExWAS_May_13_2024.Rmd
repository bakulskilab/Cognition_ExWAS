---
title: "Multiple imputation for cognition ExWAS and SVI interaction analyses"
author: "Erika Walker"
date: "`r Sys.Date()`"
output: html_document
---

Purpose: run multiple imputation with chained equations (MICE) to prepare data for both cognition ExWAS and SVI interaction analyses

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(haven)
library(sjlabelled)
library(mice)
```

# Load data to impute
```{r}

cog_ewas_to_impute <- readRDS('Data/cognition_ewas_svi_to_impute.RDS')
dim(cog_ewas_to_impute) # 29896    39

```

# Prep data for imputation
Imputing the original variables whenever feasible, then will recalculate SVI with the new data
```{r}
# TO IMPUTE - cognitive outcome (DSST), covariates: education (DMDEDUC2), smoking (smk_status), cotinine (LBXCOT),
# fish/seafood consumption (total_seafood_score), alcohol (alc_month_freq), BMI (BMXBMI), waist circumference (BMXWAIST), 
# creatinine (URXUCR), SVI components: income (INDFMPIR), insurance (ins_status), housing tenure (HOQ065), 
# food insecurity (ad_foodsec), employment (employed)

# made decision Mar 20 to not impute eGFR and restrict only to those with observed normal values for sensitivity analysis

# create a copy of cotinine LBXCOT - to use an unimputed version as an exposure and an imputed version as a covariate
cog_ewas_to_impute <- cog_ewas_to_impute %>%
  mutate(LBXCOT_imp = LBXCOT)

# define list of variables to impute
vars_to_impute <- c('INDFMPIR', 'DMDEDUC2', 'ins_status', 'HOQ065', 'ad_foodsec', 'employed', 
                    'smk_status', 'LBXCOT_imp', 'URXUCR', 'DSST', 'total_seafood_score',
                    'alc_month_freq', 'BMXBMI', 'BMXWAIST')

# check missings in included participants
included <- cog_ewas_to_impute %>%
  filter(include == 1)

summary(included$INDFMPIR) 
summary(included$DSST)
summary(included$LBXCOT_imp) 
summary(included$URXUCR) 
summary(included$total_seafood_score) 
summary(included$BMXBMI) 
summary(included$BMXWAIST)
summary(included$alc_month_freq) 

table(included$DMDEDUC2, useNA = 'always')
table(included$ins_status, useNA = 'always')
table(included$HOQ065, useNA = 'always') 
table(included$ad_foodsec, useNA = 'always') 
table(included$employed, useNA = 'always')
table(included$smk_status, useNA = 'always')

# summarize missing Ns for each variable (for included participants only)
missings <- as.data.frame(sapply(included, function(x) sum(is.na(x)))) %>%
  filter(rownames(.) %in% vars_to_impute)

# convert to factors for imputation - in full dataset
cog_ewas_to_impute <- cog_ewas_to_impute %>%
  as_label(smk_status, ins_status, ad_foodsec, employed,
           keep.labels = T) %>% # specify keep.labels = T to be able to convert back to numeric later if needed
  mutate(HOQ065 = factor(HOQ065,
                         levels = c(1:3)),
         DMDEDUC2 = factor(DMDEDUC2,
                           levels = c(1:5)))

table(cog_ewas_to_impute$smk_status, useNA = 'always')
table(cog_ewas_to_impute$ins_status, useNA = 'always')
table(cog_ewas_to_impute$ad_foodsec, useNA = 'always')
table(cog_ewas_to_impute$employed, useNA = 'always')
table(cog_ewas_to_impute$HOQ065, useNA = 'always')
table(cog_ewas_to_impute$DMDEDUC2, useNA = 'always')

```

# Set up imputation inputs
```{r}
var_list <- colnames(cog_ewas_to_impute)

# variables to NOT use as predictors in the imputation: exclude any of the SVI components that are dependent on the variables being imputed (ex: svi_income is calculated from INDFMPIR), survey weights, anything else that may cause issues
excl_vars <- c('SEQN', 'SDMVPSU', 'SDMVSTRA', 'WTMEC2YR', 'WTMEC4YR', 'WTINT2YR', 'WTINT4YR', 
               'VNEGFR', 'include', 'LBXCOT', 'hs_educ', 'total_seafood_grp', 'alc4', 'DMDEDUC3',
               'svi_income', 'svi_educ', 'svi_ins', 'svi_race', 'svi_tenure', 'svi_foodsec', 'svi_employment', 'svi')

remaining <- intersect(setdiff(var_list, excl_vars), setdiff(var_list, vars_to_impute))
# 4 additional

# set some of these to always include as predictors - basic demographics with complete info are good to include
include_vars <- c('RIDAGEYR', 'RIAGENDR', 'RIDRETH1')

# set up predictor matrix
# quickpred will select predictors for each variable with missing data
pred <- quickpred(cog_ewas_to_impute,
                  include = include_vars, # always use as predictors
                  exclude = excl_vars) # never use as predictors

# run mice with 0 iterations first to pull list of methods
imp <- mice(data = cog_ewas_to_impute, 
            predictorMatrix = pred,
            maxit = 0)
methods <- imp$method
print(methods)

# check for logged events
imp$loggedEvents

# create list of all non-imputing variables
not_imputing <- setdiff(var_list, vars_to_impute)

# set methods of all non-imputing variables to empty
methods[not_imputing] <- ""

# set imputation methods by variable type
# continuous
cont <- c('INDFMPIR', 'LBXCOT_imp', 'URXUCR', 'DSST', 'total_seafood_score', 'alc_month_freq', 'BMXBMI', 'BMXWAIST')

# unordered categorical
unord <- c('ins_status', 'HOQ065', 'smk_status')

# ordered categorical
ord <- c('ad_foodsec', 'DMDEDUC2')

#binomial
bin <- 'employed'

methods[cont] <- 'pmm' # predictive mean modeling
methods[unord] <- 'polyreg' # polytomous logistic regression
methods[ord] <- 'polr' # proportional odds model
methods[bin] <- 'logreg' # logistic regression

print(methods)
rm(imp)

# specify not to impute any data for excluded participants by creating a 'where' matrix
# matrix of true/false for each data point: F = don't impute, T = impute

# pull list of row numbers of participants to not impute (include == 0)
no_imp <- cog_ewas_to_impute %>%
  mutate(n_row = row_number()) %>%
  filter(include == 0) %>%
  select(n_row, SEQN, include)
dim(no_imp) # 24914     3 --> double check 29896-4982=24914

# set the cells for those participants to FALSE in the 'where' matrix to pass to mice()
where <- make.where(cog_ewas_to_impute)
where[no_imp$n_row, ] <- FALSE

```

# Run imputation
```{r}

# use the previously defined pred matrix, methods list, and where matrix
imputed <- mice(cog_ewas_to_impute, 
                m = 5, # now running 5 instead of single (Jan 24)
                maxit = 5, # number of iterations per imputation, 5 is default
                predictorMatrix = pred,
                method = methods, 
                where = where, # specifying to not impute for excluded participants
                seed = 456) # set for reproducibility

# check for logged events
imputed$loggedEvents

```

# Clean up imputed dataset
```{r}

# turn into a long dataset, each imputation is stacked
imputed_df <- complete(imputed, action = 'long')
dim(imputed_df) # 149480     42 --> confirm, 29896*5=149480

# check variables to make sure all missings were actually imputed for the included group
summary((imputed_df %>% filter(include == 1))$INDFMPIR)
summary((imputed_df %>% filter(include == 1))$LBXCOT_imp)
summary((imputed_df %>% filter(include == 1))$URXUCR)
summary((imputed_df %>% filter(include == 1))$DSST)
summary((imputed_df %>% filter(include == 1))$total_seafood_score)
summary((imputed_df %>% filter(include == 1))$alc_month_freq)
summary((imputed_df %>% filter(include == 1))$BMXBMI)
summary((imputed_df %>% filter(include == 1))$BMXWAIST)
table((imputed_df %>% filter(include == 1))$DMDEDUC2, useNA = 'always')
table((imputed_df %>% filter(include == 1))$ins_status, useNA = 'always')
table((imputed_df %>% filter(include == 1))$HOQ065, useNA = 'always')
table((imputed_df %>% filter(include == 1))$ad_foodsec, useNA = 'always')
table((imputed_df %>% filter(include == 1))$employed, useNA = 'always')
table((imputed_df %>% filter(include == 1))$smk_status, useNA = 'always')

# recategorize education, seafood group, and alcohol consumption based on imputed continuous vars
imputed_df <- imputed_df %>%
  mutate(hs_educ = case_when(DMDEDUC2 %in% c(1, 2) ~ 0,
                             DMDEDUC2 %in% c(3, 4, 5) ~ 1),
         total_seafood_grp = case_when(total_seafood_score == 0 ~ '0',
                                       total_seafood_score %in% c(1:3) ~ '1-3',
                                       total_seafood_score >= 4 ~ '4+'),
         alc4 = case_when(alc_month_freq <= 4 ~ 0,
                          alc_month_freq > 4 ~ 1))

table((imputed_df %>% filter(include == 1))$hs_educ, useNA = 'always')
table((imputed_df %>% filter(include == 1))$total_seafood_grp, useNA = 'always')
table((imputed_df %>% filter(include == 1))$alc4, useNA = 'always')

# convert ins_status back to numeric for creating SVI
imputed_df <- imputed_df %>%
  mutate(ins_status = case_when(ins_status == 'Private insurance' ~ 0,
                                ins_status == 'Government insurance' ~ 0.5,
                                ins_status == 'No insurance' ~ 1))

table((imputed_df %>% filter(include == 1))$ins_status, useNA = 'always')

# recalculate all of the SVI components and overall score in the imputed dataset
imputed_df <- imputed_df %>%
# Income
# 1 point on index if 1.5 or below, 0 if above
    mutate(svi_income = ifelse(INDFMPIR <= 1.5, 1, 0)) %>%

# Education
# 1 point on index if no hs ed, 0 if yes
    mutate(svi_educ = ifelse(DMDEDUC2 %in% c(1, 2), 1, 0)) %>%

# Health insurance
# Coding is same as ins_status: 1 point on index if no ins, 0.5 if govt ins, 0 if private ins
    mutate(svi_ins = ins_status) %>%

# Race/ethnicity
# Coding: 0 points on index if non hispanic white, 1 point for all others
    mutate(svi_race = ifelse(RIDRETH1 == 3, 0, 1)) %>%

# Housing tenure
# 1 point for rent or other, 0 for own home
    mutate(svi_tenure = case_when(HOQ065 == 1 ~ 0, # homeowner
                                  HOQ065 %in% c(2, 3) ~ 1, # rent or other
                                  .default = NA)) %>%
  
# Food security
# 1 point on index if less than full security, 0 if fully secure
    mutate(svi_foodsec = ifelse(ad_foodsec != 'Full security', 1, 0)) %>%
  
# Employment
# 1 point if unemployed or retired, 0 if employed
    mutate(svi_employment = ifelse(employed == 'Unemployed or retired', 1, 0)) %>%

# sum up for SVI overall
    mutate(svi = svi_income + svi_educ + svi_ins + svi_race + 
             svi_tenure + svi_foodsec + svi_employment)

# check components in included group
table((imputed_df %>% filter(include == 1))$svi_income, useNA = 'always')
table((imputed_df %>% filter(include == 1))$svi_educ, useNA = 'always')
table((imputed_df %>% filter(include == 1))$svi_ins, useNA = 'always')
table((imputed_df %>% filter(include == 1))$svi_race, useNA = 'always')
table((imputed_df %>% filter(include == 1))$svi_tenure, useNA = 'always')
table((imputed_df %>% filter(include == 1))$svi_foodsec, useNA = 'always')
table((imputed_df %>% filter(include == 1))$svi_employment, useNA = 'always')

summary((imputed_df %>% filter(include == 1))$svi)
# mean 2.784

# compare to pre imputed
summary(included$svi)
# mean 2.753 - very close

```

# Add missing labels to imputed_df
```{r}

#get_label(imputed_df)

# variable labels
imputed_df <- imputed_df %>%
  copy_labels(cog_ewas_to_impute)

get_label(imputed_df)
# a few still blank

imputed_df <- imputed_df %>%
  var_labels(.imp = 'Imputation number',
             .id = 'Imputation row number',
             DMDEDUC2 = 'Education level - Adults 20+',
             HOQ065 = 'Home owned, bought, rented, or other')

```


# Save imputed dataset
```{r}

saveRDS(imputed_df, file = 'Data/cognition_ewas_svi_imputed.RDS')

```



